# Deploy website-ts ke VPS (rickychen930.cloud)
# Frontend → /var/www/website-ts/build (Nginx)
# Backend → /root/backend (PM2, port 4000)
#
# Secrets (Settings → Secrets and variables → Actions):
#   SSH_HOST     - IP atau hostname VPS (contoh: 72.60.208.150)
#   SSH_USER     - User SSH (contoh: root)
#   SSH_PRIVATE_KEY - Private key lengkap (-----BEGIN ... END-----)

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20"

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build frontend
        env:
          NODE_ENV: production
          REACT_APP_API_URL: https://rickychen930.cloud
        run: npm run build

      - name: Build backend
        run: npx tsc -p backend/tsconfig.backend.json

      - name: Run tests (optional)
        run: |
          npm run test:ci --if-present
          npm run test:backend --if-present

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deploy-artifacts
          path: |
            build
            backend/dist
            backend/ecosystem.config.js
            package.json
            package-lock.json

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    if: success()
    # Opsional: pakai environment 'production' untuk protection rules
    # environment: production
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: deploy-artifacts

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy frontend (Nginx)
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            build/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/website-ts/build/
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo chown -R www-data:www-data /var/www/website-ts/build"

      - name: Deploy backend (PM2)
        run: |
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            backend/dist/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/root/backend/dist/
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            backend/ecosystem.config.js ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/root/backend/
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            package.json package-lock.json ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/root/backend/

      - name: Install deps & restart backend
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd /root/backend && npm ci --only=production --legacy-peer-deps && pm2 reload website-backend --update-env || (pm2 delete website-backend 2>/dev/null; pm2 start ecosystem.config.js --env production) && pm2 save"

      - name: Verify deployment
        run: |
          sleep 5
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "curl -sf http://localhost:4000/health && echo ' Backend OK' || (echo 'Backend health check failed'; pm2 logs website-backend --lines 20 --nostream; exit 1)"

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
